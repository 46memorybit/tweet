<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Tweet Logs Graph</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body {
    font-family: sans-serif;
    margin: 20px;
  }
  .controls {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 20px;
  }
  .group {
    border: 1px solid #ccc;
    padding: 10px;
    min-width: 200px;
  }
</style>
</head>
<body>

<h2>Tweet Logs 時系列グラフ</h2>

<div id="controls" class="controls"></div>

<canvas id="chart" height="120"></canvas>

<script>
/* =====================
   設定
===================== */
const OWNER = '46memorybit';
const REPO  = 'tweet';
const BASE_PATH = 'logs';

/* =====================
   GitHub API
===================== */
async function fetchJSON(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error(res.status + ' ' + url);
  return res.json();
}

/* =====================
   CSV → 時系列変換
===================== */
function csvToTimeSeries(csvText) {
  const lines = csvText.trim().split('\n');
  const headers = lines[0].split(',');

  const labels = [];
  const values = [];

  for (let i = 1; i < lines.length; i++) {
    const cols = lines[i].split(',');
    const date = cols[0];

    for (let h = 1; h < headers.length; h++) {
      labels.push(`${date}/${headers[h]}`);
      values.push(Number(cols[h]));
    }
  }
  return { labels, values };
}

/* =====================
   CSV 全取得
===================== */
async function loadAllCSVs() {
  const folders = await fetchJSON(
    `https://api.github.com/repos/${OWNER}/${REPO}/contents/${BASE_PATH}`
  );

  const datasets = [];

  for (const folder of folders.filter(f => f.type === 'dir')) {
    const files = await fetchJSON(folder.url);

    for (const file of files.filter(f => f.name.endsWith('.csv'))) {
      const csvText = await fetch(file.download_url).then(r => r.text());
      const ts = csvToTimeSeries(csvText);

      datasets.push({
        folder: folder.name,
        file: file.name,
        label: `${folder.name}/${file.name}`,
        labels: ts.labels,
        data: ts.values
      });
    }
  }
  return datasets;
}

/* =====================
   Chart.js 初期化
===================== */
const chart = new Chart(
  document.getElementById('chart'),
  {
    type: 'line',
    data: { labels: [], datasets: [] },
    options: {
      responsive: true,
      interaction: { mode: 'nearest', intersect: false },
      scales: {
        x: {
          ticks: {
            autoSkip: true,
            maxRotation: 90,
            minRotation: 90
          }
        },
        y: {
          beginAtZero: true
        }
      }
    }
  }
);

/* =====================
   チェックボックス生成
===================== */
function buildControls(datasets) {
  const container = document.getElementById('controls');
  container.innerHTML = '';

  const byFolder = {};
  datasets.forEach(d => {
    byFolder[d.folder] ??= [];
    byFolder[d.folder].push(d);
  });

  Object.entries(byFolder).forEach(([folder, files]) => {
    const div = document.createElement('div');
    div.className = 'group';

    const folderCb = document.createElement('input');
    folderCb.type = 'checkbox';
    folderCb.checked = true;

    const title = document.createElement('label');
    title.textContent = ' ' + folder;

    div.append(folderCb, title, document.createElement('br'));

    files.forEach(f => {
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.checked = true;
      cb.onchange = updateChart;

      f._cb = cb;

      div.append(cb, ' ' + f.file, document.createElement('br'));
    });

    folderCb.onchange = () => {
      files.forEach(f => f._cb.checked = folderCb.checked);
      updateChart();
    };

    container.appendChild(div);
  });
}

/* =====================
   グラフ更新
===================== */
function updateChart() {
  chart.data.datasets = [];
  chart.data.labels = [];

  const active = datasets.filter(d => d._cb.checked);
  if (active.length === 0) {
    chart.update();
    return;
  }

  // X軸は最初の有効データを基準
  chart.data.labels = active[0].labels;

  active.forEach(d => {
    chart.data.datasets.push({
      label: d.label,
      data: d.data,
      borderWidth: 1
    });
  });

  chart.update();
}

/* =====================
   起動
===================== */
let datasets = [];

(async () => {
  try {
    datasets = await loadAllCSVs();
    buildControls(datasets);
    updateChart();
  } catch (e) {
    console.error(e);
    alert('データ取得に失敗しました。Consoleを確認してください。');
  }
})();
</script>

</body>
</html>

