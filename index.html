<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Tweet Logs 時系列グラフ</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { font-family: sans-serif; margin: 20px; }
.controls { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 20px; }
.group { border: 1px solid #ccc; padding: 10px; min-width: 220px; }
</style>
</head>
<body>

<h2>Tweet Logs 時系列グラフ</h2>

<div id="controls" class="controls"></div>
<canvas id="chart" height="140"></canvas>

<script>
/* ========= 設定 ========= */
const OWNER = '46memorybit';
const REPO  = 'tweet';
const BASE_PATH = 'logs';

/* ========= GitHub API ========= */
async function fetchJSON(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error(res.status + ' ' + url);
  return res.json();
}

/* ========= CSV → 時系列（完全耐性版） ========= */
function csvToTimeSeries(csvText) {
  csvText = csvText.replace(/^\uFEFF/, ''); // BOM除去
  const lines = csvText.split(/\r?\n/).filter(l => l.trim() !== '');
  const headers = lines[0].split(',').map(h => h.trim());

  const labels = [];
  const values = [];

  for (let i = 1; i < lines.length; i++) {
    const cols = lines[i].split(',').map(c => c.trim());
    const date = cols[0];

    for (let h = 1; h < headers.length; h++) {
      if (cols[h] === undefined || cols[h] === '') continue;

      const v = Number(cols[h]);
      if (Number.isNaN(v)) continue;

      labels.push(`${date}/${headers[h]}`);
      values.push(v);
    }
  }

  return { labels, values };
}

/* ========= CSV 全取得 ========= */
async function loadAllCSVs() {
  const folders = await fetchJSON(
    `https://api.github.com/repos/${OWNER}/${REPO}/contents/${BASE_PATH}`
  );

  const datasets = [];

  for (const folder of folders.filter(f => f.type === 'dir')) {
    const files = await fetchJSON(folder.url);

    for (const file of files.filter(f => f.name.endsWith('.csv'))) {
      const csvText = await fetch(file.download_url).then(r => r.text());
      const ts = csvToTimeSeries(csvText);

      console.log(file.name, ts.values.slice(0, 5)); // ★確認用

      datasets.push({
        folder: folder.name,
        file: file.name,
        label: `${folder.name}/${file.name}`,
        labels: ts.labels,
        data: ts.values
      });
    }
  }
  return datasets;
}

/* ========= Chart ========= */
const chart = new Chart(document.getElementById('chart'), {
  type: 'line',
  data: { labels: [], datasets: [] },
  options: {
    responsive: true,
    scales: {
      x: { ticks: { autoSkip: true, maxRotation: 90, minRotation: 90 }},
      y: { beginAtZero: true }
    }
  }
});

/* ========= チェックボックス ========= */
function buildControls(datasets) {
  const container = document.getElementById('controls');
  container.innerHTML = '';

  const byFolder = {};
  datasets.forEach(d => (byFolder[d.folder] ??= []).push(d));

  Object.entries(byFolder).forEach(([folder, files]) => {
    const div = document.createElement('div');
    div.className = 'group';

    const folderCb = document.createElement('input');
    folderCb.type = 'checkbox';
    folderCb.checked = true;
    div.append(folderCb, ' ' + folder, document.createElement('br'));

    files.forEach(f => {
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.checked = true;
      cb.onchange = updateChart;
      f._cb = cb;
      div.append(cb, ' ' + f.file, document.createElement('br'));
    });

    folderCb.onchange = () => {
      files.forEach(f => f._cb.checked = folderCb.checked);
      updateChart();
    };

    container.appendChild(div);
  });
}

/* ========= グラフ更新 ========= */
function updateChart() {
  chart.data.datasets = [];
  chart.data.labels = [];

  const active = datasets.filter(d => d._cb.checked);
  if (active.length === 0) return chart.update();

  chart.data.labels = active[0].labels;

  active.forEach(d => {
    chart.data.datasets.push({
      label: d.label,
      data: d.data,
      borderWidth: 1
    });
  });

  chart.update();
}

/* ========= 起動 ========= */
let datasets = [];
(async () => {
  datasets = await loadAllCSVs();
  buildControls(datasets);
  updateChart();
})();
</script>

</body>
</html>

